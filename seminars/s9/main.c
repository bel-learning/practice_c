#ifndef __PROGTEST__
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <assert.h>
#include <ctype.h>
#endif /* __PROGTEST__ */
#define INITIAL_STR_LEN 100

char **decrypt(const char *key, const char *str)
{
    /* TODO: Your code here */
    if (key == NULL || str == NULL)
    {
        return NULL;
    }
    if (strlen(key) == 0)
    {
        return NULL;
    }

    size_t resSize = 0;
    size_t resCapacity = 10;
    char **resStr = (char **)malloc(resCapacity * sizeof(char *));
    for (size_t i = 0; i < resCapacity; i++)
    {
        resStr[i] = (char *)malloc(INITIAL_STR_LEN * sizeof(char));
    }
    size_t *sizeCon = (size_t *)malloc(resCapacity * sizeof(*sizeCon));
    size_t cnt = 0;
    size_t kCnt = 0;
    size_t conWhiteSpace = 0;
    char currentCh;
    while (1)
    {
        if (conWhiteSpace > 1)
        {
            return NULL;
        }
        if (resSize >= resCapacity)
        {
            resCapacity *= 2;
            resStr = (char **)realloc(resStr, resCapacity * sizeof(char *));
            for (int i = resCapacity / 2; i < resCapacity; i++)
            {
                resStr[i] = (char *)malloc(resCapacity * sizeof(char));
            }
            sizeCon = (size_t *)realloc(sizeCon, resSize * sizeof(*sizeCon));
        }
        if (cnt >= sizeCon[resSize] - 1)
        {
            sizeCon[resSize] *= 2;
            resStr[resSize] = (char *)realloc(resStr[resSize], sizeCon[resSize] * sizeof(char));
        }
        if (key[kCnt] == '\0')
        {
            kCnt = 0;
        }

        currentCh = ((*str) ^ (key[kCnt]));
        if(currentCh == '<' || currentCh == '\0') {
            
            resStr[resSize][cnt] = '\0';
            // printf("zeroing: %lu\n", resSize);
            resStr[resSize+1] = NULL;
            break;
        }
        if (isspace(currentCh))
        {
            // printf("Next char: %c\n", (*(str+1)) ^ (key[kCnt+1]));
            char tmp = (*(str+1)) ^ (key[kCnt+1]) ;
            // ending so doesn't matter
            if(tmp == '\0') {
                    resStr[resSize][cnt] = NULL;
                    resSize++;
                    resStr[resSize] = NULL;
                    break;
                }
            if(cnt != 0) {
                resStr[resSize][cnt] = NULL;
                conWhiteSpace++;
                resSize++;
                cnt = -1;
            }
            else {
                kCnt++;
                str++;
                conWhiteSpace++;
                continue;
            } 
            
        }
        else{
            conWhiteSpace = 0;
            resStr[resSize][cnt] = currentCh;
        }
        str++;
        kCnt++;
        cnt++;
        
    }
    // for(int i = 0; i < resSize; i++) {
    //     printf(">%s<\n",resStr[i]);
    // }
    // resStr[resSize] = (char *) realloc(resStr[resSize], sizeCon[resSize] * sizeof(char));
    // resStr[resSize] = NULL;
    // printf("arr: %lu\n", resSize);
    return resStr;
}

#ifndef __PROGTEST__
void destroyLogs(char **memblock)
{
    if (!memblock)
        return;
    for (size_t i = 0; memblock[i] != NULL; ++i)
        free(memblock[i]);
    free(memblock);
}

int main(int argc, char *argv[])
{
    char **result;
    const char strbig[] = {
     0x6c, 0x72, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,
        0x6c, 0x72, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c,  
    };
    
    result = decrypt("<3progtest", strbig);
    const char str0[] = {
        0x6c, 0x72, 0x41, 0x52, 0x1d, 0x12, 0x18, 0x00,
        0x09, 0x0e, 0x3c};
    result = decrypt("<3progtest", str0);
    
    assert(!strcmp(result[0], "PA1"));
    assert(!strcmp(result[1], "rulezz"));
    assert(result[2] == NULL);
    destroyLogs(result);

    const char str1[] = {
        0x1b, 0x45, 0x0d, 0x03, 0x7f, 0x08, 0x41, 0x3e,
        0x61, 0x52, 0x26, 0x44, 0x09, 0x65, 0x1f, 0x0b,
        0x00, 0x13, 0x41};
    result = decrypt("I love PA1", str1);
    assert(!strcmp(result[0], "Real"));
    assert(!strcmp(result[1], "man"));
    assert(!strcmp(result[2], "code"));
    assert(!strcmp(result[3], "in"));
    assert(!strcmp(result[4], "C"));
    assert(result[5] == NULL);
    destroyLogs(result);

    const char str2[] = {
        0x19, 0x06, 0x1d, 0x7f, 0x1b, 0x55, 0x24, 0x75,
        0x15, 0x65, 0x09, 0x02, 0x28, 0x1c, 0x06, 0x54,
        0x0e, 0x4f, 0x25, 0x17, 0x10, 0x46, 0x6f};
    result = decrypt("Monty Python", str2);
    assert(!strcmp(result[0], "Tis"));
    assert(!strcmp(result[1], "but"));
    assert(!strcmp(result[2], "a"));
    assert(!strcmp(result[3], "flesh"));
    assert(!strcmp(result[4], "wound."));
    assert(result[5] == NULL);
    destroyLogs(result);

    const char str3[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x53,
        0x49, 0x11, 0x10, 0x4e, 0x10, 0x4f, 0x09, 0x1a,
        0x00, 0x55, 0x73};
    result = decrypt(" Romanes eunt domus ", str3);
    assert(!strcmp(result[0], "Romani"));
    assert(!strcmp(result[1], "ite"));
    assert(!strcmp(result[2], "domum"));
    assert(result[3] == NULL);
    destroyLogs(result);

        const char str4[] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x53,
            0x00, 0x0c, 0x01, 0x0b, 0x54, 0x44, 0x0b, 0x02,
            0x18, 0x18, 0x53, 0x20};
    result = decrypt(" Romanes eunt domus ", str4);
    assert(result == NULL);
    destroyLogs(result);

    const char str5[] = {
        0x70, 0x59, 0x39, 0x07, 0x01, 0x1a, 0x29, 0x79};
    result = decrypt("Python", str5);
    assert(result == NULL);
    destroyLogs(result);

    assert(decrypt(NULL, "1234") == NULL);
    return 0;
}
#endif /* __PROGTEST__ */
